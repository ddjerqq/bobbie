import disnake

from models.item import Item
from models.user import User
from models.database import Database


class EmbedService:
    def __init__(self, database: Database):
        self._database = database

    @staticmethod
    def cooldown(action: str, reason: str, retry_after: float | int) -> disnake.Embed:
        """
        :param action: рЃерЃћрЃю рЃБрЃЎрЃЋрЃћ {action}
        :param reason: рЃерЃћрЃю рЃўрЃАрЃћрЃЋ рЃерЃћрЃФрЃџрЃћрЃЉ {reason}
        :param retry_after: seconds, _error.retry_after
        """
        embed = disnake.Embed(title=f"рЃюрЃћрЃџрЃљ рЃќрЃЋрЃўрЃљрЃЊрЃў",
                              color=0xFF0000,
                              description=f"рЃерЃћрЃю рЃБрЃЎрЃЋрЃћ {action}, \n"
                                          f"рЃерЃћрЃю рЃўрЃАрЃћрЃЋ рЃерЃћрЃФрЃџрЃћрЃЉ {reason} {(retry_after // 60):.0f} рЃгрЃБрЃЌрЃерЃў")
        return embed

    @staticmethod
    def rob_success(target: disnake.Member, stolen: int) -> disnake.Embed:
        em = disnake.Embed(color=0x00ff00,
                           description=f"рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃФрЃљрЃарЃфрЃЋрЃћ {target.name}")
        em.description += f"\nрЃЏрЃЮрЃърЃљрЃарЃћ {stolen} РѓЙ"
        return em

    @staticmethod
    def rob_success_died(target: disnake.Member) -> disnake.Embed:
        em = disnake.Embed(color=0xff0000, title=f"рЃерЃћрЃю рЃЏрЃЮрЃЎрЃЋрЃЊрЃў {target.name}'рЃўрЃА рЃФрЃљрЃарЃфрЃЋрЃўрЃА рЃЊрЃарЃЮрЃА ­ЪцБ",
                           description=f"рЃерЃћрЃюрЃў рЃАрЃљрЃцрЃБрЃџрЃћ рЃњрЃљрЃЊрЃљрЃћрЃфрЃљ {target.name}'рЃА")
        return em

    @staticmethod
    def rob_err(reason: str) -> disnake.Embed:
        em = disnake.Embed(description=reason,
                           color=0xff0000)
        return em

    @staticmethod
    def econ_err_not_enough_money(where: str = "", _for: str = "", needs: int = "") -> disnake.Embed:
        """
        рЃерЃћрЃю рЃљрЃа рЃњрЃљрЃЦрЃЋрЃА рЃАрЃљрЃЎрЃЏрЃљрЃарЃўрЃАрЃў рЃцрЃБрЃџрЃў {where} {_for} \n
        рЃерЃћрЃю рЃњрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ {needs} РѓЙ \n
        :param where: wallet or bank
        :param _for: what you are trying to buy
        :param needs: how much money the user needs
        """
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃљрЃа рЃњрЃљрЃЦрЃЋрЃА рЃАрЃљрЃЎрЃЏрЃљрЃарЃўрЃАрЃў рЃцрЃБрЃџрЃў {where} {_for}",
                           color=0xff0000)
        em.description += f"\nрЃерЃћрЃю рЃњрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ {needs} РѓЙ"
        return em

    @staticmethod
    def econ_err_self_give():
        em = disnake.Embed(color=0xff0000,
                           description="рЃерЃћрЃю рЃЋрЃћрЃа рЃЏрЃўрЃфрЃћрЃЏ рЃерЃћрЃюрЃА рЃЌрЃљрЃЋрЃА рЃцрЃБрЃџрЃА")
        return em

    @staticmethod
    def econ_err_user_not_found(username: str) -> disnake.Embed:
        em = disnake.Embed(color=0xff0000,
                           description=f"рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў рЃАрЃљрЃ«рЃћрЃџрЃўрЃЌ '{username}' рЃљрЃа рЃљрЃарЃўрЃА рЃЉрЃљрЃќрЃљрЃерЃў")
        return em

    async def econ_util_balance(self, target: disnake.Member) -> disnake.Embed:
        user = await self._database.user_service.get(target.id)

        em = disnake.Embed(
            title=f"{target.name}'рЃА рЃЉрЃљрЃџрЃљрЃюрЃАрЃў",
            color=0x2d56a9)
        em.set_thumbnail(url=target.avatar.url)

        em.add_field(name="рЃЉрЃљрЃюрЃЎрЃў",
                     value=f"{user.bank}")
        em.add_field(name="рЃАрЃљрЃцрЃБрЃџрЃћ",
                     value=f"{user.wallet}")
        em.set_footer(text=f"Exp: {user.experience}")

        return em

    @staticmethod
    def econ_err_invalid_amount() -> disnake.Embed:
        em = disnake.Embed(description=f"рЃерЃћрЃўрЃДрЃЋрЃљрЃюрЃћ рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ рЃарЃЮрЃњрЃЮрЃарЃф рЃарЃўрЃфрЃ«рЃЋрЃў, \n"
                                       f"рЃљрЃю рЃЊрЃљрЃгрЃћрЃарЃћ [max, all, рЃАрЃБрЃџ]",
                           color=0xff0000)
        return em

    @staticmethod
    def econ_success_deposit(user: User, amount) -> disnake.Embed:
        em = disnake.Embed(description=f"рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃерЃћрЃўрЃбрЃљрЃюрЃћ рЃЉрЃљрЃюрЃЎрЃерЃў {amount} РѓЙ",
                           color=0x00ff00)
        em.add_field(name="рЃЉрЃљрЃюрЃЎрЃў", value=f"{user.bank}")
        em.add_field(name="рЃАрЃљрЃцрЃБрЃџрЃћ", value=f"{user.wallet}")
        return em

    @staticmethod
    def econ_success_withdraw(user: User, amount: int) -> disnake.Embed:
        em = disnake.Embed(description=f"рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃЏрЃЮрЃўрЃбрЃљрЃюрЃћ {amount} РѓЙ рЃЉрЃљрЃюрЃЎрЃўрЃЊрЃљрЃю",
                           color=0x00ff00)
        em.add_field(name="рЃЉрЃљрЃюрЃЎрЃў", value=f"{user.bank}")
        em.add_field(name="рЃАрЃљрЃцрЃБрЃџрЃћ", value=f"{user.wallet}")
        return em

    @staticmethod
    def econ_success_give(user: User, target: User, amount: int):
        em = disnake.Embed(color=0x00ff00,
                           description=f"рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЏрЃўрЃћрЃфрЃў {target.username}'рЃА {amount} РѓЙ")

        em.add_field(name="рЃерЃћрЃЉрЃў рЃЉрЃљрЃюрЃЎрЃў",
                     value=f"{user.bank}")
        em.add_field(name="рЃерЃћрЃюрЃў рЃАрЃљрЃцрЃБрЃџрЃћ",
                     value=f"{user.wallet}")
        em.add_field(name="рЃерЃћрЃюрЃў XP",
                     value=f"{user.experience}")

        em.add_field(name=f"{target.username}'рЃА рЃЉрЃљрЃюрЃЎрЃў",
                     value=f"{target.bank}")
        em.add_field(name=f"{target.username}'рЃА рЃАрЃљрЃцрЃБрЃџрЃћ",
                     value=f"{target.wallet}")
        em.add_field(name=f"{target.username}'рЃА XP",
                     value=f"{target.experience}")
        return em

    @staticmethod
    def inv_err_item_not_in_shop(item_slug: str) -> disnake.Embed:
        item = Item.new(item_slug)
        em = disnake.Embed(description=f"{item.name} рЃљрЃа рЃўрЃДрЃўрЃЊрЃћрЃЉрЃљ",
                           color=0xff0000)
        return em

    @staticmethod
    def inv_err_item_not_buyable(item_slug: str) -> disnake.Embed:
        item = Item.new(item_slug)
        em = disnake.Embed(color=0xff0000,
                           description=f"рЃерЃћрЃю рЃЋрЃћрЃа рЃўрЃДрЃўрЃЊрЃў {item.name}рЃА, рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃњрЃљрЃДрЃўрЃЊрЃЋрЃљрЃљ рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃћрЃџрЃў")
        return em

    @staticmethod
    def inv_err_item_not_in_inventory(item: str):
        item = Item.new(item)
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃљрЃа рЃњрЃљрЃЦрЃЋрЃА {item.name}",
                           colour=0xff0000)
        return em

    @staticmethod
    def inv_success_bought_item(item: Item) -> disnake.Embed:
        em = disnake.Embed(description=f"рЃгрЃљрЃарЃЏрЃљрЃЉрЃўрЃЌ рЃўрЃДрЃўрЃЊрЃћ {item.name}",
                           color=0x00ff00)
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity_string}` - `{item.rarity:.8f}`")
        em.set_footer(text=f"ID: {item.id}")
        return em

    async def inv_util_inventory(self, target: disnake.Member) -> disnake.Embed:
        user = await self._database.user_service.get(target.id)
        items = await self._database.item_service.get_all_by_owner_id(user.id)

        total_price = sum(item.price for item in items)

        em = disnake.Embed(title=f"{user.username}'рЃўрЃА рЃўрЃюрЃЋрЃћрЃюрЃбрЃљрЃарЃў",
                           description=f"{len(items)} рЃюрЃўрЃЋрЃЌрЃў, рЃАрЃБрЃџ {total_price} РѓЙ",)

        item_types: dict[str, list[Item]] = {i: [] for i in set(map(lambda x: x.type, items))}

        for item in items:
            item_types[item.type].append(item)

        for item_type, items in item_types.items():
            item_types[item_type].sort(key=lambda x: x.rarity)
            tot_price = sum(i.price for i in items)

            em.add_field(name=f"{items[0].emoji}{items[0].name} Рћђ {len(item_types[item_type])}",
                         value=f"`рЃ»рЃљрЃЏрЃБрЃарЃў рЃцрЃљрЃАрЃў`: `{tot_price}` РѓЙ")

        return em

    @staticmethod
    def fish(item: Item, broken: bool) -> disnake.Embed:
        tool = Item.new("fishing_rod")
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃгрЃљрЃ«рЃЋрЃћрЃЊрЃў рЃАрЃљрЃЌрЃћрЃЋрЃќрЃљрЃЮрЃЊ рЃЊрЃљ рЃЊрЃљрЃўрЃГрЃўрЃарЃћ ***{item.name}*** {tool.emoji}",
                           color=0x00ff00 if not broken else 0xff0000)
        em.description += "\nрЃерЃћрЃю рЃњрЃљрЃбрЃћрЃ«рЃћ рЃерЃћрЃюрЃў рЃљрЃюрЃЎрЃћрЃАрЃў" if broken else ""
        em.add_field(name="рЃдрЃўрЃарЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ",
                     value=f"`{item.price}` РѓЙ")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity_string}`\n")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity:.8f}`")
        em.set_thumbnail(url=item.thumbnail or tool.thumbnail)
        return em

    @staticmethod
    def hunt(item: Item, broken: bool) -> disnake.Embed:
        tool = Item.new("hunting_rifle")
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃгрЃљрЃ«рЃЋрЃћрЃЊрЃў рЃАрЃљрЃюрЃљрЃЊрЃўрЃарЃЮрЃЊ рЃЊрЃљ рЃЏрЃЮрЃўрЃюрЃљрЃЊрЃўрЃарЃћ ***{item.name}*** {tool.emoji}",
                           color=0x00ff00 if not broken else 0xff0000)
        em.description += "\nрЃерЃћрЃю рЃњрЃљрЃбрЃћрЃ«рЃћ рЃерЃћрЃюрЃў рЃАрЃљрЃюрЃљрЃЊрЃўрЃарЃЮ рЃЌрЃЮрЃцрЃў" if broken else ""
        em.add_field(name="рЃдрЃўрЃарЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ",
                     value=f"`{item.price}` РѓЙ")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity_string}`\n")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity:.8f}`")
        em.set_thumbnail(url=item.thumbnail or tool.thumbnail)
        return em

    @staticmethod
    def dig(item: Item, broken: bool) -> disnake.Embed:
        tool = Item.new("shovel")
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃўрЃбрЃћ рЃљрЃЏрЃЮрЃњрЃћрЃЌрЃ«рЃарЃљ рЃАрЃљрЃЊрЃЏрЃћ рЃЏрЃўрЃгрЃљ, рЃЉрЃћрЃЋрЃарЃў рЃЮрЃцрЃџрЃўрЃА рЃЊрЃљрЃдрЃЋрЃарЃўрЃА рЃЏрЃћрЃарЃћ рЃерЃћрЃю рЃўрЃърЃЮрЃЋрЃћ "
                                       f"***{item.name}*** {tool.emoji}",
                           color=0x00ff00 if not broken else 0xff0000)
        em.description += "\nрЃерЃћрЃю рЃњрЃљрЃбрЃћрЃ«рЃћ рЃерЃћрЃюрЃў рЃюрЃўрЃЕрЃљрЃЉрЃў" if broken else ""
        em.add_field(name="рЃдрЃўрЃарЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ",
                     value=f"`{item.price}` РѓЙ")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity_string}`\n")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity:.8f}`")
        em.set_thumbnail(url=item.thumbnail or tool.thumbnail)
        return em

    @staticmethod
    def sell(item: Item) -> disnake.Embed:
        em = disnake.Embed(description=f"рЃерЃћрЃю рЃњрЃљрЃДрЃўрЃЊрЃћ {item.name}{item.emoji}",
                           color=0x00ff00)
        em.add_field(name="рЃдрЃўрЃарЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ",
                     value=f"`{item.price}` РѓЙ")
        em.add_field(name="рЃўрЃерЃЋрЃўрЃљрЃЌрЃЮрЃЉрЃљ",
                     value=f"`{item.rarity_string}` - `{item.rarity:.8f}`")
        em.set_footer(text=f"ID: {item.id} | Created at: {item.creation_date}")
        return em
